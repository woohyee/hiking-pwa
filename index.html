<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìš´ë™ ì‚°ì±… ê¸°ë¡ ì•±</title>
  <script src="https://cdn.jsdelivr.net/npm/idb@7/build/iife/index-min.js"></script>
  <style>
    body {
      font-size: 42px; /* ì „ì²´ ê¸€ì”¨ í¬ê¸° 2ë°° ì´ìƒ í™•ëŒ€ */
      padding: 20px;
      text-align: center;
    }
    button {
      font-size: 38px; /* ë²„íŠ¼ ê¸€ì”¨ í¬ê¸° ëŒ€í­ í™•ëŒ€ */
      padding: 20px 30px;
      margin-top: 30px;
      width: 90%;
      max-width: 500px;
    }
    div {
      margin-bottom: 25px;
    }
  </style>
</head>
<body>
  <h2>ğŸï¸ ìš´ë™ ì‚°ì±… ê¸°ë¡ ì•± ğŸŒ³</h2>
  <div>ìƒíƒœ: <span id="status">ëŒ€ê¸°ì¤‘</span></div>
  <div>ì¥ì†Œ: <span id="location">ì•Œ ìˆ˜ ì—†ìŒ</span></div>
  <div>ê±¸ìŒìˆ˜: <span id="steps">0</span> ê±¸ìŒ</div>
  <div>ì´ë™ê±°ë¦¬: <span id="distance">0</span> m</div>
  <div>ìš´ë™ì‹œê°„: <span id="time">0</span> ì´ˆ</div>

  <button id="startBtn">ğŸš¶ ìš´ë™ ì‹œì‘</button>
  <button id="memoBtn">ğŸ“ ì¥ì†Œ ë©”ëª¨ ì¶”ê°€</button>

<script>
const dbPromise = idb.openDB('hiking-app', 1, {
  upgrade(db) {
    db.createObjectStore('places', {keyPath: 'id', autoIncrement: true});
    db.createObjectStore('records', {keyPath: 'id', autoIncrement: true});
  }
});

let steps = 0, distance = 0, timer = null, elapsedTime = 0;
let lastCoords = null, isMoving = false;
let currentLocation = null;
const locations = [];

async function loadPlaces() {
  const db = await dbPromise;
  locations.push(...await db.getAll('places'));
}
loadPlaces();

function calculateDistance(c1, c2) {
  const R = 6371e3, toRad = deg => deg * Math.PI / 180;
  const Ï†1 = toRad(c1.latitude), Ï†2 = toRad(c2.latitude);
  const Î”Ï† = toRad(c2.latitude - c1.latitude);
  const Î”Î» = toRad(c2.longitude - c1.longitude);
  const a = Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

navigator.geolocation.watchPosition(pos => {
  const coords = pos.coords;
  if (!lastCoords) updateLocation(coords);

  if (isMoving && lastCoords) {
    distance += calculateDistance(lastCoords, coords);
    document.getElementById('distance').textContent = distance.toFixed(1);
  }

  lastCoords = coords;
}, err => alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'), {enableHighAccuracy: true});

function updateLocation(coords) {
  currentLocation = locations.find(loc => calculateDistance(coords, loc.coords) <= loc.radius);

  if (!currentLocation) {
    const name = prompt('ìƒˆë¡œìš´ ì¥ì†Œì…ë‹ˆë‹¤! ì¥ì†Œ ì´ë¦„ì„ ì…ë ¥í•˜ë©´ ì €ì¥ë©ë‹ˆë‹¤:');
    if (name) saveNewLocation(name, coords);
    document.getElementById('location').textContent = name || 'ë¯¸ë“±ë¡ ì¥ì†Œ';
  } else {
    document.getElementById('location').textContent = currentLocation.name;
  }
}

async function saveNewLocation(name, coords) {
  const db = await dbPromise;
  const newPlace = {name, coords, radius: 300, created: new Date()};
  locations.push(newPlace);
  await db.add('places', newPlace);
}

document.getElementById('startBtn').onclick = function() {
  if (isMoving) {
    stopWorkout();
  } else {
    startWorkout();
  }
};

function startWorkout() {
  isMoving = true;
  document.getElementById('status').textContent = "ìš´ë™ì¤‘";
  document.getElementById('startBtn').textContent = "â¹ï¸ ìš´ë™ ì¢…ë£Œ";
  window.addEventListener('devicemotion', countSteps);
  timer = setInterval(() => {
    elapsedTime++;
    document.getElementById('time').textContent = elapsedTime;
  }, 1000);
}

function stopWorkout() {
  isMoving = false;
  document.getElementById('status').textContent = "ëŒ€ê¸°ì¤‘";
  document.getElementById('startBtn').textContent = "ğŸš¶ ìš´ë™ ì‹œì‘";
  window.removeEventListener('devicemotion', countSteps);
  clearInterval(timer);
}

function countSteps(e) {
  const {x,y,z} = e.accelerationIncludingGravity;
  const magnitude = Math.sqrt(x*x + y*y + z*z);
  if (magnitude > 12) {
    steps++;
    document.getElementById('steps').textContent = steps;
  }
}

document.getElementById('memoBtn').onclick = async function() {
  if (!currentLocation) return alert('ë“±ë¡ëœ ì¥ì†Œì—ì„œë§Œ ë©”ëª¨ ì¶”ê°€ ê°€ëŠ¥!');
  const memo = prompt('ì´ ì¥ì†Œì— ëŒ€í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
  if (memo) {
    const db = await dbPromise;
    currentLocation.memo = memo;
    await db.put('places', currentLocation);
    alert('ë©”ëª¨ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
  }
};
</script>
</body>
</html>
