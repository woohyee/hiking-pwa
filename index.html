<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìë™ ìš´ë™ & ì‚°ì±… ê¸°ë¡ ì•±</title>
  <script src="https://cdn.jsdelivr.net/npm/idb@7/build/iife/index-min.js"></script>
</head>
<body>
  <h2>ğŸï¸ ìë™ ìš´ë™ & ì‚°ì±… ê¸°ë¡ ì•± ğŸŒ³</h2>
  <div>ìƒíƒœ: <span id="status">íœ´ì‹ì¤‘</span></div>
  <div>ì¥ì†Œ: <span id="location">ì•Œ ìˆ˜ ì—†ìŒ</span></div>
  <div>ê±¸ìŒìˆ˜: <span id="steps">0</span> ê±¸ìŒ</div>
  <div>ì´ë™ê±°ë¦¬: <span id="distance">0</span> m</div>
  <div>ìš´ë™ì‹œê°„: <span id="time">0</span> ì´ˆ</div>
  <button onclick="addMemo()">í˜„ì¬ ì¥ì†Œì— ì‚¬ì§„/ë©”ëª¨ ì¶”ê°€</button>

  <script>
  const dbPromise = idb.openDB('hiking-app', 1, {
    upgrade(db) {
      db.createObjectStore('places', {keyPath: 'id', autoIncrement: true});
      db.createObjectStore('records', {keyPath: 'id', autoIncrement: true});
    }
  });

  let steps = 0, distance = 0, timer = null, elapsedTime = 0;
  let lastCoords = null, isMoving = false, lastMotionTime = Date.now();
  let currentLocation = null;

  const locations = [];

  async function loadPlaces() {
    const db = await dbPromise;
    locations.push(...await db.getAll('places'));
  }

  loadPlaces();

  function calculateDistance(c1, c2) {
    const R = 6371e3, toRad = deg => deg * Math.PI / 180;
    const Ï†1 = toRad(c1.latitude), Ï†2 = toRad(c2.latitude);
    const Î”Ï† = toRad(c2.latitude - c1.latitude);
    const Î”Î» = toRad(c2.longitude - c1.longitude);
    const a = Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function updateLocation(coords) {
    currentLocation = locations.find(loc => calculateDistance(coords, loc.coords) <= loc.radius);

    if (!currentLocation) {
      const name = prompt('ìƒˆë¡œìš´ ì¥ì†Œì…ë‹ˆë‹¤! ì¥ì†Œ ì´ë¦„ì„ ì…ë ¥í•˜ë©´ ì €ì¥ë©ë‹ˆë‹¤:');
      if (name) saveNewLocation(name, coords);
      document.getElementById('location').textContent = name || 'ë¯¸ë“±ë¡ ì¥ì†Œ';
    } else {
      document.getElementById('location').textContent = currentLocation.name;
    }
  }

  async function saveNewLocation(name, coords) {
    const db = await dbPromise;
    const newPlace = {name, coords, radius: 300, created: new Date()};
    locations.push(newPlace);
    await db.add('places', newPlace);
  }

  navigator.geolocation.watchPosition(pos => {
    const coords = pos.coords;
    if (!lastCoords) updateLocation(coords);

    if (lastCoords) {
      distance += calculateDistance(lastCoords, coords);
      document.getElementById('distance').textContent = distance.toFixed(1);
    }

    lastCoords = coords;
  }, err => console.error(err), {enableHighAccuracy: true});

  window.addEventListener('devicemotion', e => {
    const {x, y, z} = e.accelerationIncludingGravity;
    const magnitude = Math.sqrt(x*x + y*y + z*z);

    if (magnitude > 12) {
      steps++;
      document.getElementById('steps').textContent = steps;
      lastMotionTime = Date.now();

      if (!isMoving) startWorkout();
    }
  });

  function startWorkout() {
    isMoving = true;
    document.getElementById('status').textContent = "ìš´ë™ì¤‘";
    timer = setInterval(() => {
      elapsedTime++;
      document.getElementById('time').textContent = elapsedTime;

      if (Date.now() - lastMotionTime > 120000) stopWorkout();
    }, 1000);
  }

  async function stopWorkout() {
    isMoving = false;
    clearInterval(timer);
    document.getElementById('status').textContent = "íœ´ì‹ì¤‘";

    const db = await dbPromise;
    const record = {
      date: new Date(),
      location: currentLocation ? currentLocation.name : 'ë¯¸ë“±ë¡ ì¥ì†Œ',
      steps, distance, elapsedTime
    };

    await db.add('records', record);
    console.log('ìš´ë™ê¸°ë¡ ì €ì¥ë¨:', record);

    steps = distance = elapsedTime = 0;
    document.getElementById('steps').textContent = 0;
    document.getElementById('distance').textContent = 0;
    document.getElementById('time').textContent = 0;
  }

  async function addMemo() {
    if (!currentLocation) return alert('ë“±ë¡ëœ ì¥ì†Œì—ì„œë§Œ ë©”ëª¨ ì¶”ê°€ ê°€ëŠ¥!');
    const memo = prompt('ì´ ì¥ì†Œì— ëŒ€í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
    if (memo) {
      const db = await dbPromise;
      currentLocation.memo = memo;
      await db.put('places', currentLocation);
      alert('ë©”ëª¨ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }
  }
  </script>
</body>
</html>
